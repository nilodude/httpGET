#include <Arduino.h>
#include <WiFi.h>
#include <HTTPClient.h>
#include <MD_MAX72xx.h>
#include <SPI.h>

#define HARDWARE_TYPE MD_MAX72XX::FC16_HW
#define MAX_DEVICES 2

#define CLK_PIN   18 
#define DATA_PIN  17 
#define CS_PIN    16 

#define numFrames 290

unsigned int updatedNumFrames = numFrames;

MD_MAX72XX matrix = MD_MAX72XX(HARDWARE_TYPE, DATA_PIN, CLK_PIN, CS_PIN, MAX_DEVICES);

int cols = 8;

String getFlamaURL = "http://192.168.1.89:8080/flama?numFrames=";
char* getNumFramesURL = "http://192.168.1.89:8080/numFrames";

char flamaURL[44];

WiFiClient client;
HTTPClient http;
bool isWifiSetup = false;
bool downloaded = false;
bool offLine = false;

byte llamita[numFrames][16]={
{0,0,0,0,2,6,15,15,31,31,31,31,63,62,62,30},
{0,0,0,0,2,6,15,15,31,31,31,31,31,63,30,30},
{0,0,0,0,2,6,15,15,31,31,31,31,31,31,30,30},
{0,0,0,0,0,6,15,15,31,31,31,31,31,31,30,30},
{0,0,0,0,0,6,15,15,31,31,31,31,31,31,30,30},
{0,0,0,0,0,6,15,15,31,31,31,31,31,31,30,30},
{0,0,0,0,0,7,15,15,15,31,31,31,31,31,30,30},
{0,0,0,0,0,7,7,15,15,31,31,31,31,31,30,30},
{0,0,0,0,1,7,7,15,15,31,31,31,31,31,30,30},
{0,0,0,0,1,3,7,15,15,15,31,31,31,31,30,30},
{0,0,0,0,1,3,7,7,15,15,31,31,31,31,30,30},
{0,0,0,0,1,3,7,7,15,15,31,31,31,31,30,30},
{0,0,0,0,1,3,7,7,15,15,31,31,31,31,30,30},
{0,0,0,0,1,3,7,7,15,15,31,31,31,31,30,30},
{0,0,0,0,1,3,7,7,15,15,31,31,31,31,30,62},
{0,0,0,0,1,3,7,7,15,15,31,31,31,31,30,62},
{0,0,0,0,1,3,7,15,15,31,31,31,31,31,62,62},
{0,0,0,0,1,3,7,15,15,31,31,31,31,30,62,62},
{0,0,0,0,1,3,7,15,15,31,31,31,31,62,62,62},
{0,0,0,0,1,7,15,15,31,31,31,31,63,62,62,62},
{0,0,0,0,3,7,15,15,31,31,31,63,62,62,62,60},
{0,0,0,0,6,15,15,31,31,31,31,63,62,62,62,60},
{0,0,0,0,6,14,15,31,31,31,63,62,62,62,62,60},
{0,0,0,0,6,14,30,30,30,30,62,62,62,62,60,60},
{0,0,0,0,14,14,30,30,30,62,62,62,62,62,60,60},
{0,0,0,0,12,14,30,30,62,62,62,62,62,60,60,60},
{0,0,0,0,12,28,30,30,62,62,62,62,62,60,60,60},
{0,0,0,0,12,28,30,62,62,62,62,62,60,60,60,60},
{0,0,0,0,12,28,28,62,62,62,62,62,60,60,60,60},
{0,0,0,0,28,28,60,62,62,62,62,62,60,60,60,60},
{0,0,0,0,28,28,60,62,62,62,62,62,60,60,60,60},
{0,0,0,0,28,28,60,62,62,62,62,62,60,60,60,60},
{0,0,0,8,28,28,60,62,62,62,62,62,60,60,60,60},
{0,0,0,8,28,28,60,62,62,62,62,62,60,60,60,60},
{0,0,0,8,28,28,62,62,62,62,62,62,60,60,60,60},
{0,0,0,12,28,28,62,62,62,62,62,60,60,60,60,60},
{0,0,0,12,28,28,62,62,62,62,62,60,60,60,60,60},
{0,0,0,12,28,28,30,62,62,62,62,60,60,60,60,60},
{0,0,0,12,28,28,30,62,62,62,62,60,60,60,60,60},
{0,0,0,12,28,28,28,62,62,62,62,60,124,124,60,60},
{0,0,0,12,28,28,28,62,62,62,60,124,124,124,124,60},
{0,0,0,12,28,28,28,60,62,62,124,124,124,124,124,124},
{0,0,0,8,28,28,60,60,60,60,124,124,124,124,124,124},
{0,0,0,0,12,28,60,60,60,124,124,124,124,124,124,124},
{0,0,0,0,12,28,60,60,60,124,124,124,124,124,124,124},
{0,0,0,0,8,28,60,60,124,124,124,124,124,124,124,124},
{0,0,0,0,0,24,60,60,124,124,124,124,124,124,124,124},
{0,0,0,0,0,24,60,60,124,124,124,252,124,124,124,124},
{0,0,0,0,0,24,56,124,124,124,252,252,252,252,124,124},
{0,0,0,0,0,0,56,120,124,252,252,252,252,252,124,124},
{0,0,0,0,0,0,48,120,248,252,252,252,252,252,252,124},
{0,0,0,0,0,0,0,112,248,248,248,252,252,252,252,124},
{0,0,0,0,0,0,0,240,248,248,248,248,252,252,252,248},
{0,0,0,0,0,0,0,224,240,248,248,248,248,248,248,248},
{0,0,0,0,0,0,0,224,240,240,248,248,248,248,248,248},
{0,0,0,0,0,0,0,192,224,240,248,248,248,248,248,248},
{0,0,0,0,0,0,128,224,224,240,240,248,248,248,248,248},
{0,0,0,0,0,0,192,224,224,240,240,248,248,248,248,248},
{0,0,0,0,0,128,192,224,240,240,240,248,248,248,248,248},
{0,0,0,0,128,192,224,224,240,240,240,248,248,248,248,88},
{0,0,0,0,192,192,224,240,240,240,248,248,248,248,248,88},
{0,0,0,128,192,224,224,240,240,248,248,248,248,248,120,88},
{0,0,0,192,224,240,240,240,248,248,248,248,248,120,120,88},
{0,0,0,96,112,112,248,248,248,248,248,120,120,120,120,72},
{0,0,0,0,48,56,120,124,124,124,124,124,124,124,124,104},
{0,0,0,0,24,60,60,60,124,124,124,124,124,124,124,108},
{0,0,0,0,28,28,62,62,62,62,124,124,124,124,124,108},
{0,0,0,0,12,28,30,62,62,62,62,124,124,124,124,104},
{0,0,0,0,0,12,30,62,62,62,62,124,124,124,124,120},
{0,0,0,0,0,8,28,60,62,62,62,60,124,124,124,120},
{0,0,0,0,0,24,28,60,60,60,60,60,124,124,124,120},
{0,0,0,0,16,24,60,60,60,60,60,60,60,124,124,120},
{0,0,0,0,24,24,56,60,60,60,60,60,60,124,124,124},
{0,0,0,0,0,24,24,24,60,60,60,60,60,124,124,124},
{0,0,0,0,0,0,0,8,24,28,60,60,62,126,124,124},
{0,0,0,0,0,0,0,0,0,24,28,62,126,126,124,124},
{0,0,0,0,0,0,0,0,0,0,16,124,254,126,126,60},
{0,0,0,0,0,0,0,0,0,0,96,252,254,254,254,126},
{0,0,0,0,0,0,0,0,0,0,224,248,252,254,254,254},
{0,0,0,0,0,0,0,0,0,0,224,248,252,254,254,254},
{0,0,0,0,0,0,0,0,0,0,0,240,248,252,252,252},
{0,0,0,0,0,0,0,0,0,0,0,0,224,240,252,252},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,240,248},
{0,0,0,0,0,0,0,0,0,0,0,0,96,248,248,248},
{0,0,0,0,0,0,0,0,0,0,248,252,252,252,252,240},
{0,0,0,0,0,0,0,60,254,252,252,252,252,252,120,64},
{0,0,0,0,0,127,255,254,254,124,124,124,120,120,120,64},
{0,0,0,255,127,127,127,126,124,60,56,56,56,56,56,56},
{120,255,255,255,127,63,62,56,56,56,56,56,56,56,56,56},
{127,28,28,28,28,24,24,56,56,56,56,56,56,56,56,56},
{0,8,8,24,24,24,56,56,56,56,56,56,120,120,120,120},
{0,0,0,24,24,56,56,56,120,120,120,120,120,120,120,120},
{0,0,12,28,28,60,56,56,120,120,120,120,120,120,120,120},
{0,0,0,8,24,24,56,56,56,56,120,120,248,248,248,248},
{0,0,0,0,0,0,0,0,0,48,112,248,248,248,248,248},
{0,0,0,0,0,0,0,0,0,64,240,240,248,248,248,248},
{0,0,0,0,0,0,0,0,0,224,240,248,248,248,248,248},
{0,0,0,0,0,0,0,0,192,224,240,248,248,248,248,248},
{0,0,0,0,0,0,0,192,224,240,248,248,252,252,252,124},
{0,0,0,0,0,0,0,224,240,248,252,252,252,124,124,124},
{0,0,0,0,0,0,0,96,120,252,252,252,252,252,252,124},
{0,0,0,0,0,0,0,0,120,124,252,252,252,252,252,248},
{0,0,0,0,0,0,0,0,32,248,252,252,252,252,248,248},
{0,0,0,0,0,0,0,0,240,248,248,248,248,248,248,248},
{0,0,0,0,0,0,0,64,240,248,248,248,248,248,248,248},
{0,0,0,0,0,0,0,192,224,240,240,240,248,248,248,248},
{0,0,0,0,0,0,0,192,224,224,240,240,240,240,240,240},
{0,0,0,0,0,0,0,128,192,192,224,224,240,240,240,240},
{0,0,0,0,0,0,0,0,128,192,192,224,224,240,240,240},
{0,0,0,0,0,0,0,0,128,192,192,224,224,240,240,240},
{0,0,0,0,0,0,0,0,128,192,224,224,240,240,248,248},
{0,0,0,0,0,0,0,0,128,192,224,240,240,248,248,120},
{0,0,0,0,0,0,0,128,192,224,240,248,248,124,124,124},
{0,0,0,0,0,128,192,224,240,248,120,124,124,124,124,124},
{0,0,128,192,224,240,248,124,124,60,60,60,60,60,60,124},
{0,224,240,120,60,60,60,60,62,62,62,62,60,60,124,124},
{0,0,0,8,12,12,12,28,28,60,60,60,60,124,120,120},
{0,0,0,0,0,12,28,28,60,60,60,120,120,120,120,120},
{0,0,0,0,12,28,28,60,60,56,120,120,120,120,120,120},
{0,0,0,4,12,28,60,60,60,120,120,120,120,120,120,120},
{0,0,0,6,14,30,60,60,60,56,120,120,120,120,120,120},
{0,0,0,6,14,30,30,62,62,62,60,60,124,124,120,120},
{0,0,0,3,7,15,31,31,31,62,62,62,60,60,124,120},
{0,0,0,0,1,7,15,15,31,31,62,62,60,60,124,120},
{0,0,0,0,0,3,7,15,31,30,62,62,60,60,124,124},
{0,0,0,0,0,0,7,15,31,30,62,62,60,60,124,124},
{0,0,0,0,0,0,7,15,30,62,62,60,60,124,124,124},
{0,0,0,0,0,0,14,30,62,60,60,124,124,124,124,124},
{0,0,0,0,0,0,28,60,60,60,124,124,124,124,124,124},
{0,0,0,0,0,8,60,60,124,124,124,124,124,124,124,124},
{0,0,0,0,0,24,56,124,124,124,124,124,124,124,60,60},
{0,0,0,0,24,60,60,124,124,124,124,124,60,60,60,60},
{0,0,0,0,30,30,62,62,62,62,62,62,60,60,60,60},
{0,0,0,6,15,31,31,30,62,62,62,62,60,60,60,60},
{0,0,0,7,15,31,31,30,30,30,30,30,60,60,60,60},
{0,0,0,6,14,30,30,30,30,30,30,30,60,60,60,60},
{0,0,0,0,0,4,14,30,30,30,30,62,60,60,60,124},
{0,0,0,0,0,0,0,12,30,30,62,62,60,124,124,124},
{0,0,0,0,0,0,0,28,62,62,126,126,124,124,124,124},
{0,0,0,0,0,0,28,62,62,126,126,126,124,124,124,60},
{0,0,0,0,0,14,62,62,126,126,126,126,62,60,60,60},
{0,0,0,0,0,31,63,63,63,62,62,62,62,60,60,60},
{0,0,0,0,0,15,31,63,63,63,62,62,62,62,60,60},
{0,0,0,0,0,6,15,31,31,31,31,62,62,62,62,60},
{0,0,0,0,0,0,0,6,15,15,31,31,63,62,62,60},
{0,0,0,0,0,0,0,0,0,6,15,31,63,63,62,126},
{0,0,0,0,0,0,0,0,0,0,15,63,63,127,126,126},
{0,0,0,0,0,0,0,0,0,0,31,63,127,127,126,126},
{0,0,0,0,0,0,0,0,0,31,127,127,127,127,126,124},
{0,0,0,0,0,0,0,0,31,127,127,127,127,127,126,60},
{0,0,0,0,0,0,15,63,127,127,127,127,127,126,126,60},
{0,0,0,0,0,15,63,127,127,127,127,127,127,62,62,60},
{0,0,0,0,0,31,63,127,127,127,127,127,62,62,60,60},
{0,0,0,0,0,7,63,127,127,127,127,63,62,62,62,60},
{0,0,0,0,0,0,31,63,127,63,63,63,63,62,62,60},
{0,0,0,0,0,0,7,31,31,63,63,63,63,62,62,60},
{0,0,0,0,0,0,0,3,15,31,31,63,63,63,62,126},
{0,0,0,0,0,0,0,0,0,1,3,15,31,63,63,127},
{0,0,0,0,0,0,0,0,0,0,0,0,3,15,63,127},
{0,0,0,0,0,0,0,0,0,0,0,0,0,31,127,127},
{0,0,0,0,0,0,0,0,0,0,0,0,15,63,127,127},
{0,0,0,0,0,0,0,0,0,0,0,0,31,63,127,127},
{0,0,0,0,0,0,0,0,0,0,0,15,63,127,127,127},
{0,0,0,0,0,0,0,0,0,0,7,31,63,127,127,127},
{0,0,0,0,0,0,0,0,0,3,15,31,63,127,127,127},
{0,0,0,0,0,0,0,0,3,15,31,63,63,127,127,63},
{0,0,0,0,0,0,0,3,15,31,31,63,63,63,63,63},
{0,0,0,0,0,1,7,15,15,31,31,63,63,63,63,62},
{0,0,0,0,3,7,15,31,31,31,31,63,63,63,62,62},
{0,0,1,7,15,15,31,31,31,31,63,63,63,62,62,62},
{0,0,3,7,31,31,31,31,63,31,31,31,30,62,62,60},
{0,0,3,15,31,31,31,31,31,63,63,62,62,62,60,60},
{0,0,1,15,31,31,63,62,62,62,62,62,60,60,60,60},
{0,0,0,30,62,60,124,124,124,124,124,124,124,124,124,120},
{0,0,28,124,248,248,248,248,248,248,248,248,248,248,248,120},
{0,48,248,240,240,240,240,240,248,248,248,248,252,252,252,252},
{0,0,224,224,224,224,224,240,240,240,248,252,252,254,254,254},
{0,0,0,0,0,0,0,0,0,0,0,0,14,15,31,31},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,15},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,31},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,15},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,15},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,31},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,15},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,15},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,8},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,8},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,8},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,56},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,120,252},
{0,0,0,0,0,0,0,0,0,0,0,0,0,120,252,252},
{0,0,0,0,0,0,0,0,0,0,0,56,124,254,254,252},
{0,0,0,0,0,0,0,0,16,60,62,126,126,126,254,204},
{0,0,0,0,0,0,28,31,63,63,63,63,62,126,124,12},
{0,0,0,12,31,31,31,31,31,63,63,63,62,62,60,44},
{6,15,15,15,15,15,15,31,31,63,63,63,62,62,62,60},
{7,3,3,3,3,7,15,31,63,63,63,127,127,63,62,62},
{0,0,0,0,0,0,0,0,62,63,127,127,127,127,127,62},
{0,0,0,0,0,0,0,0,16,126,127,127,127,127,127,127},
{0,0,0,0,0,0,0,0,0,124,126,127,127,127,127,127},
{0,0,0,0,0,0,0,0,0,48,126,127,127,127,127,127},
{0,0,0,0,0,0,0,0,0,0,60,62,127,127,127,63},
{0,0,0,0,0,0,0,0,0,0,0,30,63,63,63,63},
{0,0,0,0,0,0,0,0,0,0,0,0,30,63,63,63},
{0,0,0,0,0,0,0,0,0,0,0,0,0,31,63,63},
{0,0,0,0,0,0,0,0,0,0,0,0,0,6,63,63},
{0,0,0,0,0,0,0,0,0,0,0,0,0,0,127,63},
{0,0,0,0,0,0,0,0,0,0,0,0,0,126,127,63},
{0,0,0,0,0,0,0,0,0,0,0,0,124,127,127,127},
{0,0,0,0,0,0,0,0,0,0,0,124,254,255,127,127},
{0,0,0,0,0,0,0,0,0,0,124,254,254,255,127,127},
{0,0,0,0,0,0,0,0,0,62,254,254,254,254,254,126},
{0,0,0,0,0,0,0,0,30,254,254,254,252,252,124,124},
{0,0,0,0,0,0,0,0,63,255,254,254,254,252,124,56},
{0,0,0,0,0,0,0,0,127,255,255,255,254,126,62,60},
{0,0,0,0,0,0,0,63,255,255,255,255,126,126,62,62},
{0,0,0,0,0,0,56,255,255,255,255,126,126,62,62,60},
{0,0,0,0,0,0,240,255,255,255,255,126,62,62,60,60},
{0,0,0,0,0,128,240,252,254,254,254,126,62,60,60,60},
{0,0,0,0,128,224,240,252,252,254,126,126,126,60,60,60},
{0,0,0,192,224,240,248,252,124,124,126,126,126,62,60,60},
{128,192,224,240,248,120,124,124,124,126,126,126,62,62,62,60},
{128,96,112,56,56,60,60,60,62,62,62,62,62,62,60,60},
{0,0,16,24,28,60,60,62,62,62,62,62,62,62,60,60},
{0,0,0,8,28,28,28,62,62,62,62,62,62,62,62,60},
{0,0,0,0,12,28,30,30,31,31,31,31,63,63,62,62},
{0,0,0,0,0,0,2,7,7,15,15,31,31,31,31,62},
{0,0,0,0,0,0,0,0,0,0,7,15,31,31,63,62},
{0,0,0,0,0,0,0,0,1,7,15,31,63,63,62,62},
{0,0,0,0,0,0,1,7,15,31,31,31,63,62,62,62},
{0,0,0,0,1,3,7,15,31,31,31,31,30,30,30,30},
{0,0,0,3,7,7,15,15,31,31,31,30,30,30,30,30},
{0,1,3,7,7,15,15,15,15,15,15,31,30,30,30,30},
{0,0,0,2,6,6,7,7,15,15,15,15,15,31,30,30},
{0,0,0,0,0,0,3,3,7,7,7,15,15,31,31,30},
{0,0,0,0,0,0,0,1,3,7,7,15,15,31,31,30},
{0,0,0,0,0,0,1,3,3,7,7,15,15,31,31,30},
{0,0,0,0,0,0,1,3,3,7,7,15,15,15,31,30},
{0,0,0,0,0,0,1,3,3,7,7,15,15,15,31,30},
{0,0,0,0,0,1,1,3,7,7,7,15,15,31,31,30},
{0,0,0,0,0,1,3,3,7,7,7,15,15,31,31,30},
{0,0,0,0,0,1,3,3,7,7,15,15,15,31,30,30},
{0,0,0,0,1,3,3,7,7,7,15,15,15,31,30,30},
{0,0,0,0,1,3,7,7,7,15,15,15,31,30,30,30},
{0,0,0,1,3,3,7,7,15,15,15,31,31,30,30,30},
{0,0,0,1,3,7,7,15,15,15,15,31,30,30,30,30},
{0,0,0,3,7,7,15,15,15,15,31,30,30,30,30,30},
{0,0,0,2,7,7,15,15,15,31,31,30,30,30,30,30},
{0,0,0,0,6,15,15,15,31,31,31,30,30,30,30,62},
{0,0,0,0,6,14,15,15,31,31,31,30,30,30,62,62},
{0,0,0,0,6,14,15,31,31,31,31,30,30,30,62,62},
{0,0,0,0,6,15,15,31,31,31,31,31,30,30,30,62},
{0,0,0,0,6,15,15,31,31,31,31,31,30,30,30,62},
{0,0,0,0,6,15,15,15,31,31,31,31,31,30,30,62},
{0,0,0,0,7,15,15,15,31,31,31,31,31,30,30,62},
{0,0,0,0,7,7,15,15,31,31,31,31,31,30,30,62},
{0,0,0,2,7,7,15,15,31,31,31,31,31,30,30,62},
{0,0,0,3,7,7,15,15,31,31,31,31,31,30,30,62},
{0,0,0,3,7,7,15,15,31,31,31,31,31,30,30,62},
{0,0,0,3,7,7,15,15,31,31,31,31,31,30,30,62},
{0,0,0,3,7,7,15,15,31,31,31,31,31,30,30,62},
{0,0,0,3,7,15,15,15,31,31,31,31,30,30,30,62},
{0,0,0,3,7,15,15,31,31,31,31,31,30,30,30,62},
{0,0,2,7,7,15,15,31,31,31,31,30,30,30,62,62},
{0,0,2,6,15,15,31,31,31,31,30,30,30,30,62,62},
{0,0,2,6,14,14,31,31,31,30,30,30,30,30,62,62},
{0,0,6,6,14,14,30,30,30,30,30,30,30,62,62,62},
{0,0,4,14,14,30,30,30,30,30,30,30,62,62,62,62},
{0,0,4,14,30,30,30,30,30,30,62,62,62,62,62,62},
{0,0,12,12,30,30,30,30,62,62,62,62,62,62,62,62},
{0,0,12,12,28,30,30,62,62,62,62,62,62,62,62,62},
{0,0,12,28,28,30,30,62,62,62,62,62,62,62,62,62},
{0,0,12,28,28,28,62,62,62,62,62,62,62,62,62,62},
{0,0,8,28,28,28,60,62,62,62,62,62,62,62,62,62},
{0,0,8,28,28,60,60,60,62,62,62,62,62,62,62,62},
{0,0,24,28,28,60,60,60,62,62,62,62,62,62,62,62},
{0,0,24,28,28,60,60,60,60,62,62,62,62,62,62,62},
{0,0,24,28,28,60,60,60,60,62,62,62,62,62,62,62},
{0,0,24,28,28,60,60,60,60,62,62,62,62,62,62,62},
{0,0,24,28,28,28,60,60,60,62,62,62,62,62,62,62},
{0,8,8,28,28,28,60,60,62,62,62,62,62,62,62,62},
{0,0,8,28,28,28,60,60,62,62,62,62,62,62,62,62},
{0,0,8,28,28,28,28,62,62,62,62,62,62,62,62,62},
{0,0,12,28,28,28,28,62,62,62,62,62,62,62,62,62},
{0,0,12,12,28,28,30,30,62,62,62,62,62,62,62,62},
{0,0,12,12,28,30,30,30,30,62,62,62,62,62,62,62},
{0,0,12,12,28,30,30,30,30,62,62,62,62,62,62,62},
{0,0,12,12,14,30,30,30,30,30,62,62,62,62,62,62},
{0,0,4,12,14,30,30,30,30,30,62,62,62,62,62,62},
{0,0,4,12,14,30,30,30,30,30,62,62,62,62,62,62}
};

/*
  delayFrames = 5 ms for 374 frames
  
  delayFrames = 8 ms for 270 frames
 */
unsigned int delayFrames = 9;

void setup() {
    setupWifi();
    
    if(isWifiSetup){
      updateNumFrames();
    }
    matrix.begin();
    matrix.clear();
    cols = matrix.getColumnCount();
}

void setupWifi(){
  Serial.begin(115200);
  WiFi.begin("MiFibra-9E00", "t0rs0t0rs0");
  Serial.println("Connecting");
  long timeout = 0;
  while(WiFi.status() != WL_CONNECTED && timeout < 10000) {
    delay(500);
    Serial.print(".");
    timeout+=500;
  }
  if (timeout >= 10000){
      Serial.println("Timeout connecting to WiFi network, default config setup");
      offLine = true;
  }else{
    Serial.print("Connected to WiFi network with IP Address: ");
    Serial.println(WiFi.localIP());
    isWifiSetup = true;
  }
}

void updateNumFrames(){
  http.begin(getNumFramesURL);
  
  int httpResponseCode = http.GET();
  String response="";
  
  if (httpResponseCode>0) {
    Serial.println();
    Serial.print("getNumFrames HTTP Status: ");
    Serial.println(httpResponseCode);
   
    response = http.getString();
    
    Serial.println("updatedNumFrames: "+response);
    updatedNumFrames = response.toInt();
  }else {
    Serial.print("getNumFrames Error code: ");
    Serial.println(httpResponseCode);
    offLine = true;
    Serial.print("Default config setup. numFrames: ");
    Serial.println(numFrames);
  }
  http.end();
  
  String(getFlamaURL+response).toCharArray(flamaURL,getFlamaURL.length() + response.length()+1);
}

void loop() {
  if(!offLine && !downloaded ){
    downloadFlama();
  }

  if(downloaded || offLine){
    drawFlama();
  }
}

void downloadFlama(){
  if(WiFi.status()== WL_CONNECTED){
    parseHTTPStream(flamaURL);
  }else{
    Serial.println("WiFi Disconnected");
    
  }
}

void parseHTTPStream(const char* url) {
  
  http.begin(url);
  Serial.println();
  Serial.print("getFlama request: ");
  Serial.println(flamaURL);
  
  int httpResponseCode = http.GET();
    
  if (httpResponseCode>0) {
    Serial.print("getFlama HTTP Status: ");
    Serial.println(httpResponseCode);
   
    WiFiClient& stream = http.getStream();
    
    int charNum = 0;
    int frameIndex = 0;
    int rowIndex = 0;
    int charIndex = 0;
    byte row = 0;
    char rowChar[3] = "";
    
    while (stream.available()){
      charNum++;
      char c = stream.read();
      
      if(c != '[' && c != ',' && c !=']'){
         rowChar[charIndex++] = c;
         row = byte(atoi(rowChar));
         llamita[frameIndex][rowIndex] = row;
      }
      
      if(c == ']'){
        frameIndex++;
        charIndex = 0;
        rowChar[0]='\0';
        rowChar[1]='\0';
        rowChar[2]='\0';
      }else if(c== ','){
        rowIndex++;
        charIndex = 0;
        rowChar[0]='\0';
        rowChar[1]='\0';
        rowChar[2]='\0';
      }else if(c == '['){
        rowIndex = 0;
      }
    }
    
    Serial.println();
    Serial.print("parsed ");
    Serial.print(charNum);
    Serial.print(" characters, ");
    Serial.print(--frameIndex);
    Serial.println(" frames");
    
    downloaded = true;
  }else {
    Serial.print("getFlama Error code: ");
    Serial.println(httpResponseCode);
    offLine = true;
    downloaded = true;
  }
  
  http.end();
}

void drawFlama(){
  for ( int j = 0; j < updatedNumFrames-1; j++ ) {
    for (int i = 0; i < cols; i++ ) {
        matrix.setColumn(i, llamita[j][cols-1-i]);
    }
    delay(delayFrames);
  }  
  delay(delayFrames);
  for ( int j = updatedNumFrames-2; j >= 0; j-- ) {
    for (int i = 0; i < cols; i++ ) {
        matrix.setColumn(i, llamita[j][cols-1-i]);
    }
    delay(delayFrames);
  }  
}
